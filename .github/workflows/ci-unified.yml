name: ğŸš€ CI - Unified Complete Pipeline

on:
  push:
    branches: [ main, develop, feature/library, update-readme ]
  pull_request:
    branches: [ main, develop, feature/library, update-readme ]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip tests for faster execution'
        required: false
        default: 'false'
        type: boolean
      skip-security:
        description: 'Skip security scans'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ÃšNICO JOB: ValidaÃ§Ã£o Completa Unificada
  unified-ci:
    name: "ğŸ”„ Complete CI Pipeline"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Setup Gradle Permissions
        run: chmod +x gradlew

      # ===== 1. BUILD & UNIT TESTS =====
      - name: ğŸ—ï¸ Build & Run Tests
        id: build
        run: ./gradlew clean build jacocoTestReport
        continue-on-error: ${{ github.event.inputs.skip-tests == 'true' }}

      - name: ğŸ“Š Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Tests
          path: build/test-results/test/*.xml
          reporter: java-junit

      - name: ğŸ“ˆ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: build/reports/jacoco/

      - name: ğŸ“¦ Upload Application JAR
        uses: actions/upload-artifact@v4
        with:
          name: library-app-jar
          path: build/libs/*.jar

      # ===== 2. SECURITY ANALYSIS =====
      - name: ğŸ”’ Initialize CodeQL Security Scan
        if: github.event.inputs.skip-security != 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: ğŸ”’ Build for CodeQL Analysis
        if: github.event.inputs.skip-security != 'true'
        run: ./gradlew build -x test

      - name: ğŸ”’ Execute CodeQL Security Analysis
        if: github.event.inputs.skip-security != 'true'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # ===== 3. DEPENDENCY VULNERABILITY SCAN =====
      - name: ğŸ›¡ï¸ OWASP Dependency Vulnerability Check
        if: github.event.inputs.skip-security != 'true'
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Library Management System'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --nvdValidForHours 24

      - name: ğŸ“¤ Upload Security Scan Reports
        if: github.event.inputs.skip-security != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            reports/
            *-dependency-check-report.*

      # ===== 4. CODE QUALITY ANALYSIS =====
      - name: ğŸ¯ Setup SonarCloud Cache
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: ğŸ¯ Prepare Code for Quality Analysis
        run: ./gradlew clean build jacocoTestReport

      - name: ğŸ¯ SonarCloud Code Quality Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=codewesleylima
            -Dsonar.projectKey=codewesleylima_library
            -Dsonar.java.binaries=build/classes
            -Dsonar.junit.reportPaths=build/test-results/test
            -Dsonar.jacoco.reportPaths=build/jacoco/test.exec
            -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml

      # ===== 5. DOCKER BUILD & INTEGRATION TESTS =====
      - name: ğŸ³ Setup Docker Build Environment
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: library-management:ci-${{ github.run_id }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Integration Tests - Container Startup
        run: |
          echo "ğŸš€ Starting application container..."
          docker run --rm -d --name library-ci \
            -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=test \
            library-management:ci-${{ github.run_id }}

          echo "â³ Waiting for application health check..."
          timeout 120 bash -c 'until curl -f -s http://localhost:8080/actuator/health > /dev/null; do sleep 3; done' || \
            (echo "âŒ Health check failed after 2 minutes" && docker logs library-ci && exit 1)

          echo "âœ… Application is healthy!"

      - name: ğŸ³ Integration Tests - API Validation
        run: |
          echo "ğŸ§ª Testing API endpoints..."

          # Test GET /api/books (should return empty array)
          response=$(curl -s http://localhost:8080/api/books)
          if [ "$response" != "[]" ]; then
            echo "âŒ GET /api/books failed. Expected [], got: $response"
            docker logs library-ci
            exit 1
          fi
          echo "âœ… GET /api/books: OK"

          # Test POST /api/books (create book)
          create_response=$(curl -s -X POST http://localhost:8080/api/books \
            -H "Content-Type: application/json" \
            -d '{"title":"CI Test Book","author":"CI Author","isbn":"CI123456","publishedYear":2024}')

          if ! echo "$create_response" | grep -q '"id"'; then
            echo "âŒ POST /api/books failed. Response: $create_response"
            docker logs library-ci
            exit 1
          fi
          echo "âœ… POST /api/books: OK"

          # Test GET /api/books again (should return the created book)
          books_response=$(curl -s http://localhost:8080/api/books)
          if ! echo "$books_response" | grep -q '"title":"CI Test Book"'; then
            echo "âŒ GET /api/books after create failed. Response: $books_response"
            docker logs library-ci
            exit 1
          fi
          echo "âœ… GET /api/books (with data): OK"

          echo "ğŸ‰ All API tests passed!"

      - name: ğŸ³ Cleanup Docker Container
        if: always()
        run: |
          docker stop library-ci || true
          docker rm library-ci || true

      # ===== 6. FINAL STATUS REPORT =====
      - name: ğŸ“‹ CI Pipeline Execution Summary
        if: always()
        run: |
          echo "ğŸ¯ CI PIPELINE EXECUTION REPORT"
          echo "================================"
          echo ""
          echo "ğŸ“Š BUILD & TESTS:"
          echo "  â€¢ Build Status: ${{ steps.build.outcome == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "  â€¢ Tests Skipped: ${{ github.event.inputs.skip-tests == 'true' && 'âœ… YES' || 'âŒ NO' }}"
          echo ""
          echo "ğŸ”’ SECURITY ANALYSIS:"
          echo "  â€¢ CodeQL Scan: ${{ github.event.inputs.skip-security == 'true' && 'â­ï¸ SKIPPED' || 'âœ… EXECUTED' }}"
          echo "  â€¢ Dependency Check: ${{ github.event.inputs.skip-security == 'true' && 'â­ï¸ SKIPPED' || 'âœ… EXECUTED' }}"
          echo ""
          echo "ğŸ¯ CODE QUALITY:"
          echo "  â€¢ SonarCloud Analysis: âœ… EXECUTED"
          echo ""
          echo "ğŸ³ CONTAINER VALIDATION:"
          echo "  â€¢ Docker Build: âœ… SUCCESS"
          echo "  â€¢ Health Check: âœ… PASSED"
          echo "  â€¢ API Tests: âœ… PASSED"
          echo ""
          echo "ğŸ† OVERALL RESULT: ${{ job.status == 'success' && 'ğŸ‰ ALL CHECKS PASSED' || 'âš ï¸ SOME CHECKS FAILED' }}"
          echo ""
          echo "ğŸ“¦ Generated Artifacts:"
          echo "  â€¢ Application JAR: âœ… Available"
          echo "  â€¢ Coverage Reports: âœ… Available"
          echo "  â€¢ Security Reports: ${{ github.event.inputs.skip-security == 'true' && 'â­ï¸ Skipped' || 'âœ… Available' }}"
          echo ""
          echo "ğŸ”— Repository: https://github.com/${{ github.repository }}"
          echo "ğŸ“‹ Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
