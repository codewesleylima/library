name: CI - Unified Complete Validation Pipeline

on:
  push:
    branches: [ main, develop, feature/library, update-readme ]
  pull_request:
    branches: [ main, develop, feature/library, update-readme ]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip tests for faster execution'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Job Ãšnico: ValidaÃ§Ã£o Completa Unificada
  unified-validation:
    name: "ğŸ”„ Unified CI Pipeline"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Grant execute permission for Gradle
        run: chmod +x gradlew

      # ===== BUILD & TEST =====
      - name: ğŸ—ï¸ Build & Test Application
        id: build
        run: ./gradlew clean build jacocoTestReport
        continue-on-error: ${{ github.event.inputs.skip-tests == 'true' }}

      - name: ğŸ“Š Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Tests
          path: build/test-results/test/*.xml
          reporter: java-junit

      - name: ğŸ“ˆ Upload JaCoCo coverage
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar

      # ===== SECURITY ANALYSIS =====
      - name: ğŸ”’ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: ğŸ”’ Build for CodeQL
        run: ./gradlew build -x test

      - name: ğŸ”’ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # ===== DEPENDENCY SECURITY =====
      - name: ğŸ›¡ï¸ Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Library Management System'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --nvdValidForHours 24

      - name: ğŸ“¤ Upload dependency check results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/

      # ===== CODE QUALITY =====
      - name: ğŸ¯ Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: ğŸ¯ Build for SonarCloud
        run: ./gradlew clean build jacocoTestReport

      - name: ğŸ¯ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=codewesleylima
            -Dsonar.projectKey=codewesleylima_library
            -Dsonar.java.binaries=build/classes
            -Dsonar.junit.reportPaths=build/test-results/test
            -Dsonar.jacoco.reportPaths=build/jacoco/test.exec
            -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml

      # ===== DOCKER VALIDATION =====
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: library-management:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Test Docker image
        run: |
          echo "ğŸš€ Starting Docker container..."
          docker run --rm -d --name library-test -p 8081:8080 library-management:test

          echo "â³ Waiting for application to start..."
          timeout 60 bash -c 'until curl -f http://localhost:8081/actuator/health; do sleep 2; done' || (echo "âŒ Health check failed" && docker logs library-test && exit 1)

          echo "âœ… Health check passed!"
          echo "ğŸ§ª Testing API endpoints..."
          curl -f http://localhost:8081/api/books || (echo "âŒ API test failed" && docker logs library-test && exit 1)

          echo "âœ… API test passed!"
          docker stop library-test
          echo "ğŸ‰ All Docker tests passed!"

      # ===== FINAL STATUS =====
      - name: ğŸ¯ Pipeline Status Summary
        if: always()
        run: |
          echo "ğŸ“‹ CI Pipeline Execution Summary:"
          echo "=================================="
          echo "âœ… Build & Test: ${{ steps.build.outcome == 'success' && 'PASSED' || 'FAILED' }}"
          echo "âœ… CodeQL Security: ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}"
          echo "âœ… Dependency Check: ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}"
          echo "âœ… SonarCloud Quality: ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}"
          echo "âœ… Docker Build & Test: ${{ job.status == 'success' && 'PASSED' || 'FAILED' }}"
          echo ""
          echo "ğŸ¯ Overall Status: ${{ job.status == 'success' && 'ALL CHECKS PASSED âœ…' || 'SOME CHECKS FAILED âŒ' }}"